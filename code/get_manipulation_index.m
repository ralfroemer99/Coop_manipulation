function idx = get_manipulation_index(q)
% Compute the manipulation index as from the joint trajectory stored in q as
% idx = \sqrt(det(J(q)*J(q)^T)
N = size(q,2);
idx = zeros(1,N);

for ii = 1:N
    if mod(ii, 1000) == 0
        disp(ii);
    end
    q1 = q(1, ii);
    q2 = q(2, ii);
    q3 = q(3, ii);
    q4 = q(4, ii);
    q5 = q(5, ii);
    q6 = q(6, ii);
    q7 = q(7, ii);
    t2 = cos(q1);
    t3 = cos(q2);
    t4 = cos(q3);
    t5 = cos(q4);
    t6 = cos(q5);
    t7 = cos(q6);
    t8 = cos(q7);
    t9 = sin(q1);
    t10 = sin(q2);
    t11 = sin(q3);
    t12 = sin(q4);
    t13 = sin(q5);
    t14 = sin(q6);
    t15 = sin(q7);
    t16 = t2.*t4;
    t17 = t3.*t5;
    t18 = t5.*t7;
    t19 = t6.*t8;
    t20 = t2.*t11;
    t21 = t4.*t9;
    t22 = t3.*t12;
    t23 = t7.*t12;
    t24 = t6.*t15;
    t25 = t8.*t13;
    t26 = t9.*t11;
    t27 = t13.*t15;
    t28 = t9.*t10.*t12;
    t29 = t10.*t11.*t13;
    t30 = t11.*t13.*t14;
    t31 = t12.*t14.*t15;
    t36 = t2.*t5.*t10;
    t37 = t4.*t5.*t10;
    t38 = t5.*t6.*t14;
    t39 = t5.*t8.*t14;
    t43 = t2.*t10.*t12;
    t44 = t5.*t9.*t10;
    t45 = t4.*t10.*t12;
    t46 = t6.*t10.*t11;
    t47 = t4.*t13.*t14;
    t48 = t6.*t12.*t14;
    t49 = t5.*t14.*t15;
    t50 = t8.*t12.*t14;
    t55 = t7.*(6.3e+1./5.0e+2);
    t69 = t4.*t6.*t14.*(2.0./5.0);
    t32 = t3.*t16;
    t33 = t7.*t19;
    t34 = t3.*t20;
    t35 = t3.*t21;
    t40 = t7.*t24;
    t41 = t7.*t25;
    t42 = t3.*t26;
    t51 = t7.*t27;
    t52 = t25.*(2.0./5.0);
    t53 = t27.*(2.0./5.0);
    t58 = -t37;
    t59 = -t38;
    t61 = -t43;
    t62 = -t44;
    t63 = -t46;
    t64 = -t47;
    t65 = -t49;
    t66 = -t50;
    t70 = t12.*t19.*(2.0./5.0);
    t72 = t12.*t24.*(2.0./5.0);
    t73 = t19.*(6.3e+1./5.0e+2);
    t74 = t24.*(6.3e+1./5.0e+2);
    t75 = -t69;
    t77 = t30.*(2.1e+1./5.0e+1);
    t79 = t14.*t46.*(2.0./5.0);
    t80 = t13.*t14.*t22.*(2.0./5.0);
    t81 = t5.*t30.*(2.0./5.0);
    t83 = t4.*t23.*(2.1e+1./5.0e+1);
    t84 = t30.*(6.3e+1./5.0e+2);
    t85 = t12.*t27.*(6.3e+1./5.0e+2);
    t88 = t17+t45;
    t89 = t18+t48;
    t92 = t55+2.0./5.0;
    t94 = t38.*(6.3e+1./5.0e+2);
    t95 = t39.*(6.3e+1./5.0e+2);
    t97 = t47.*(6.3e+1./5.0e+2);
    t98 = t48.*(6.3e+1./5.0e+2);
    t99 = t12.*t25.*(6.3e+1./5.0e+2);
    t100 = t49.*(6.3e+1./5.0e+2);
    t102 = t13.*t14.*t37.*(2.0./5.0);
    t103 = t4.*t38.*(2.1e+1./5.0e+1);
    t104 = t10.*t11.*t23.*(2.1e+1./5.0e+1);
    t105 = t10.*t47.*(2.1e+1./5.0e+1);
    t131 = t10.*t11.*t38.*(2.1e+1./5.0e+1);
    t132 = t19.*t23.*(-6.3e+1./5.0e+2);
    t54 = -t53;
    t56 = -t32;
    t57 = -t33;
    t60 = -t42;
    t67 = -t51;
    t68 = t33.*(2.0./5.0);
    t71 = t40.*(2.0./5.0);
    t76 = -t70;
    t78 = t23.*t52;
    t82 = t23.*t53;
    t86 = t20+t35;
    t87 = t21+t34;
    t90 = t24+t41;
    t91 = t25+t40;
    t93 = -t80;
    t96 = t41.*(6.3e+1./5.0e+2);
    t101 = t51.*(6.3e+1./5.0e+2);
    t106 = -t94;
    t107 = -t97;
    t108 = -t100;
    t112 = t22+t58;
    t113 = t23+t59;
    t116 = -t103;
    t117 = t23.*t73;
    t118 = t23.*t74;
    t119 = -t104;
    t122 = t7.*t88;
    t123 = t3.*t89;
    t128 = t14.*t88;
    t133 = t5.*t92;
    t134 = t12.*t92;
    t109 = -t101;
    t110 = t16+t60;
    t111 = t26+t56;
    t114 = t19+t67;
    t115 = t27+t57;
    t120 = t5.*t86;
    t121 = t6.*t87;
    t124 = t4.*t90;
    t125 = t5.*t91;
    t126 = t12.*t86;
    t127 = t13.*t87;
    t129 = t11.*t90;
    t130 = t12.*t91;
    t138 = t6.*t112;
    t139 = t4.*t113;
    t145 = t13.*t112;
    t146 = -t128;
    t147 = t11.*t113;
    t179 = t106+t134;
    t186 = -t4.*(t94-t134);
    t187 = -t11.*(t94-t134);
    t188 = t98+t133+2.1e+1./5.0e+1;
    t191 = t52+t71+t74+t96;
    t224 = -t9.*(t97+t11.*(t94-t134));
    t225 = -t2.*(t97+t11.*(t94-t134));
    t236 = t2.*(t97+t11.*(t94-t134));
    t239 = t75+t77+t81+t83+t116;
    t240 = t72+t78+t99+t108+t118;
    t241 = t76+t82+t85+t95+t132;
    t260 = t79+t93+t102+t105+t119+t131;
    t135 = t5.*t111;
    t136 = t6.*t110;
    t137 = -t121;
    t140 = t4.*t114;
    t141 = -t124;
    t142 = t5.*t115;
    t143 = t12.*t111;
    t144 = t13.*t110;
    t148 = t11.*t114;
    t149 = t12.*t115;
    t152 = t28+t120;
    t153 = t31+t125;
    t154 = t62+t126;
    t155 = t29+t138;
    t156 = t30+t139;
    t157 = t65+t130;
    t164 = t63+t145;
    t165 = t64+t147;
    t170 = -t7.*(t44-t126);
    t173 = -t3.*(t49-t130);
    t175 = -t14.*(t44-t126);
    t178 = -t10.*(t49-t130);
    t183 = -t8.*(t46-t145);
    t185 = -t15.*(t46-t145);
    t189 = t3.*t188;
    t190 = t10.*t188;
    t192 = t54+t68+t73+t109;
    t202 = t84+t186;
    t207 = t107+t187;
    t150 = -t136;
    t151 = -t140;
    t158 = t36+t143;
    t159 = t39+t149;
    t160 = t6.*t152;
    t161 = t4.*t153;
    t162 = t13.*t152;
    t163 = t11.*t153;
    t166 = t61+t135;
    t167 = t66+t142;
    t172 = t7.*t155;
    t176 = t14.*t155;
    t177 = t10.*t156;
    t180 = -t6.*(t43-t135);
    t181 = -t4.*(t50-t142);
    t182 = -t13.*(t43-t135);
    t184 = -t11.*(t50-t142);
    t210 = t10.*t202;
    t223 = t3.*t202;
    t226 = -t8.*(t121+t13.*(t43-t135));
    t227 = -t2.*(t124+t11.*(t50-t142));
    t229 = -t15.*(t121+t13.*(t43-t135));
    t231 = -t9.*(t124+t11.*(t50-t142));
    t237 = t15.*(t121+t13.*(t43-t135));
    t238 = t9.*(t124+t11.*(t50-t142));
    t168 = t7.*t158;
    t169 = t3.*t159;
    t171 = t14.*t158;
    t174 = t10.*t159;
    t193 = t144+t160;
    t194 = t122+t176;
    t195 = t123+t177;
    t196 = t148+t161;
    t197 = t127+t180;
    t198 = t129+t181;
    t199 = t150+t162;
    t200 = t146+t172;
    t201 = t151+t163;
    t208 = t137+t182;
    t209 = t141+t184;
    t214 = -t8.*(t136-t162);
    t215 = -t8.*(t128-t172);
    t216 = -t2.*(t140-t163);
    t219 = -t15.*(t136-t162);
    t220 = -t15.*(t128-t172);
    t221 = -t9.*(t140-t163);
    t230 = t8.*(t128-t172);
    t233 = t15.*(t136-t162);
    t234 = t9.*(t140-t163);
    t235 = -t223;
    t261 = t189+t210;
    t203 = t7.*t193;
    t204 = t3.*t196;
    t205 = t14.*t193;
    t206 = t10.*t196;
    t211 = t7.*t197;
    t212 = t3.*t198;
    t213 = t14.*t197;
    t217 = t10.*t198;
    t252 = t183+t220;
    t259 = t185+t230;
    t262 = t190+t235;
    t218 = -t205;
    t222 = -t206;
    t228 = -t213;
    t232 = -t217;
    t242 = t175+t203;
    t243 = t178+t204;
    t246 = t171+t211;
    t247 = t174+t212;
    t263 = t9.*t262;
    t264 = t2.*t262;
    t277 = -t262.*(t206+t3.*(t49-t130));
    t279 = t262.*(t206+t3.*(t49-t130));
    t244 = t170+t218;
    t245 = t173+t222;
    t248 = t8.*t242;
    t249 = t2.*t243;
    t250 = t15.*t242;
    t251 = t9.*t243;
    t253 = t168+t228;
    t254 = t169+t232;
    t255 = t8.*t246;
    t256 = t2.*t247;
    t257 = t15.*t246;
    t258 = t9.*t247;
    t273 = t224+t264;
    t274 = t236+t263;
    t275 = t243.*t261;
    t276 = t247.*t261;
    t265 = t214+t250;
    t266 = t216+t251;
    t267 = t233+t248;
    t268 = t234+t249;
    t269 = t226+t257;
    t270 = t227+t258;
    t271 = t237+t255;
    t272 = t238+t256;
    t278 = t254.*t262;
    t287 = t275+t279;
    t280 = -t278;
    t281 = t266.*(t264-t9.*(t97+t11.*(t94-t134)));
    t282 = t270.*(t264-t9.*(t97+t11.*(t94-t134)));
    t283 = t268.*t274;
    t285 = t272.*t274;
    t284 = -t283;
    t286 = -t285;
    t288 = t276+t280;
    t289 = t281+t284;
    t290 = t282+t286;
    J = reshape([t253.*t260-t269.*t289+t271.*t290,t260.*(t205+t7.*(t44-t126))+t265.*t289-t267.*t290,-t290.*(t215+t15.*(t46-t145))-t289.*(t8.*(t46-t145)+t15.*(t128-t172))+t194.*t260,t269.*(t206+t3.*(t49-t130))+t195.*t253+t254.*t271,t195.*(t205+t7.*(t44-t126))-t265.*(t206+t3.*(t49-t130))-t254.*t267,(t206+t3.*(t49-t130)).*(t8.*(t46-t145)+t15.*(t128-t172))-t254.*(t215+t15.*(t46-t145))+t194.*t195,-t239.*t253-t269.*t287+t271.*t288,-t239.*(t205+t7.*(t44-t126))+t265.*t287-t267.*t288,-t288.*(t215+t15.*(t46-t145))-t287.*(t8.*(t46-t145)+t15.*(t128-t172))-t194.*t239,-t271.*(t124+t11.*(t50-t142))+t253.*(t47-t147)+t269.*(t140-t163),t267.*(t124+t11.*(t50-t142))+(t205+t7.*(t44-t126)).*(t47-t147)-t265.*(t140-t163),(t8.*(t46-t145)+t15.*(t128-t172)).*(t140-t163)+t194.*(t47-t147)+(t124+t11.*(t50-t142)).*(t215+t15.*(t46-t145)),t241.*t269+t240.*t271-t12.*t13.*t14.*t253.*(2.0./5.0),-t241.*t265-t240.*t267-t12.*t13.*t14.*(t205+t7.*(t44-t126)).*(2.0./5.0),-t240.*(t215+t15.*(t46-t145))+t241.*(t8.*(t46-t145)+t15.*(t128-t172))-t12.*t13.*t14.*t194.*(2.0./5.0),t89.*t253+t159.*t271+t269.*(t49-t130),t89.*(t205+t7.*(t44-t126))-t159.*t267-t265.*(t49-t130),-t159.*(t215+t15.*(t46-t145))+t89.*t194+(t8.*(t46-t145)+t15.*(t128-t172)).*(t49-t130),t191.*t269+t192.*t271-t6.*t14.*t253.*(2.0./5.0),-t191.*t265-t192.*t267-t6.*t14.*(t205+t7.*(t44-t126)).*(2.0./5.0),-t192.*(t215+t15.*(t46-t145))+t191.*(t8.*(t46-t145)+t15.*(t128-t172))-t6.*t14.*t194.*(2.0./5.0),t90.*t271-t114.*t269-t13.*t14.*t253,-t90.*t267+t114.*t265-t13.*t14.*(t205+t7.*(t44-t126)),-t90.*(t215+t15.*(t46-t145))-t114.*(t8.*(t46-t145)+t15.*(t128-t172))-t13.*t14.*t194,t8.*t14.*t269.*(6.3e+1./5.0e+2)-t14.*t15.*t271.*(6.3e+1./5.0e+2),t8.*t14.*t265.*(-6.3e+1./5.0e+2)+t14.*t15.*t267.*(6.3e+1./5.0e+2),t14.*t15.*(t215+t15.*(t46-t145)).*(6.3e+1./5.0e+2)+t8.*t14.*(t8.*(t46-t145)+t15.*(t128-t172)).*(6.3e+1./5.0e+2),t7.*t253+t8.*t14.*t271+t14.*t15.*t269,t7.*(t205+t7.*(t44-t126))-t8.*t14.*t267-t14.*t15.*t265,t7.*t194-t8.*t14.*(t215+t15.*(t46-t145))+t14.*t15.*(t8.*(t46-t145)+t15.*(t128-t172)),t8.*t271.*(-6.3e+1./5.0e+2)-t15.*t269.*(6.3e+1./5.0e+2),t8.*t267.*(6.3e+1./5.0e+2)+t15.*t265.*(6.3e+1./5.0e+2),t8.*(t215+t15.*(t46-t145)).*(6.3e+1./5.0e+2)-t15.*(t8.*(t46-t145)+t15.*(t128-t172)).*(6.3e+1./5.0e+2),t8.*t269-t15.*t271,-t8.*t265+t15.*t267,t15.*(t215+t15.*(t46-t145))+t8.*(t8.*(t46-t145)+t15.*(t128-t172)),0.0,0.0,0.0,t253,t205+t7.*(t44-t126),t194],[6,7]);
    idx(ii) = sqrt(det(J*J'));
end